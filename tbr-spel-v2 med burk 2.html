<!doctype html>
<html lang="sv">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>TBR Game üíóüìö</title>

<style>
:root{
  --bg1:#ffe9f7;
  --bg2:#efe7ff;
  --card:#ffffff;
  --stroke:rgba(234,220,243,.9);
  --text:#3b2b47;
  --muted:#8c6fa3;
  --pink:#ff8fdc;
  --purple:#b993ff;
  --shadow:0 12px 35px rgba(160,120,190,.18);
  --radius:18px;

  --postit:#fff6a8;
  --postit2:#ffe9a6;
}

*{box-sizing:border-box}
body{
  margin:0;
  font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial;
  color:var(--text);
  min-height:100vh;
  background:
    radial-gradient(900px 700px at 15% 20%, rgba(255,143,220,.55) 0%, transparent 60%),
    radial-gradient(900px 700px at 85% 25%, rgba(185,147,255,.55) 0%, transparent 60%),
    linear-gradient(135deg,var(--bg1),var(--bg2));
}

.container{
  max-width:1200px;
  margin:auto;
  padding:26px 16px 40px;
}

h1{ margin:0 0 6px; font-size: clamp(22px, 3vw, 32px); }
.sub{ margin:0 0 14px; color:var(--muted); line-height:1.35; }

.card{
  background:var(--card);
  border:1px solid var(--stroke);
  border-radius:var(--radius);
  padding:16px;
  box-shadow:var(--shadow);
}

.controls{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  align-items:center;
  justify-content:space-between;
  margin-bottom:12px;
}

.left{
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  align-items:center;
}

.btn{
  border:none;
  border-radius:14px;
  padding:10px 14px;
  cursor:pointer;
  font-weight:850;
  color:var(--text);
  background:#f4ecf9;
  box-shadow:0 8px 18px rgba(0,0,0,.06);
  transition: transform .06s ease, filter .2s ease;
}
.btn:hover{ filter: brightness(.98); }
.btn:active{ transform: translateY(1px); }

.btn.primary{
  color:white;
  background:linear-gradient(90deg,var(--pink),var(--purple));
}

.toggle{
  display:flex;
  gap:8px;
  align-items:center;
  padding:10px 12px;
  border-radius:14px;
  background:#faf7ff;
  border:1px solid var(--stroke);
  color:var(--muted);
  font-size:13px;
  font-weight:800;
}

.pills{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  margin-top:12px;
}
.pill{
  padding:7px 10px;
  border-radius:999px;
  background:#faf7ff;
  border:1px solid var(--stroke);
  color:var(--muted);
  font-size:13px;
  font-weight:800;
}
.pill strong{ color:var(--text); }

.board{
  display:grid;
  gap:10px;
  grid-template-columns: repeat(auto-fill, minmax(190px, 1fr));
}

.cell{
  border-radius:16px;
  padding:10px 12px;
  background:rgba(255,255,255,.82);
  border:1px solid rgba(0,0,0,.04);
  box-shadow:0 8px 18px rgba(0,0,0,.05);
  cursor:pointer;
  transition: transform .08s ease, filter .2s ease;
  position:relative;
  overflow:hidden;
  line-height:1.25;
  font-size:13px;
}
.cell:hover{ transform: translateY(-1px); filter: brightness(.99); }
.cell.active{
  outline:3px solid rgba(255,143,220,.85);
  box-shadow:0 18px 35px rgba(255,143,220,.18), 0 18px 35px rgba(185,147,255,.12);
}
.cell:before{
  content:"";
  position:absolute;
  inset:-40px -60px auto auto;
  width:120px;
  height:120px;
  background: rgba(255,255,255,.32);
  transform: rotate(25deg);
  border-radius: 30px;
}

.log{
  margin-top:14px;
  font-size:12px;
  color:var(--muted);
  white-space:pre-line;
  background:#faf7ff;
  border:1px solid var(--stroke);
  border-radius:16px;
  padding:12px;
}

/* Confetti */
#confetti{
  position:fixed; inset:0;
  pointer-events:none;
  z-index:9998;
  overflow:hidden;
}
.confetti{
  position:absolute;
  width:10px; height:14px;
  border-radius:3px;
  animation:fall 900ms linear forwards;
}
@keyframes fall{
  to{ transform:translateY(110vh) rotate(720deg); opacity:0; }
}

/* Result modal */
#modalWrap{
  position:fixed; inset:0;
  display:none;
  align-items:center;
  justify-content:center;
  z-index:9999;
  padding:18px;
  background: rgba(50, 20, 60, .18);
  backdrop-filter: blur(4px);
}
.modal{
  width:min(680px, 100%);
  border-radius:22px;
  background: linear-gradient(180deg, #ffffff, #faf7ff);
  border:1px solid var(--stroke);
  box-shadow: 0 26px 70px rgba(0,0,0,.18);
  padding:16px;
}
.modalTop{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  margin-bottom:10px;
}
.modalTitle{
  font-weight:950;
  font-size:14px;
  color: var(--muted);
  letter-spacing:.3px;
}
.close{
  border:none;
  cursor:pointer;
  border-radius:14px;
  padding:8px 10px;
  font-weight:900;
  background:#f4ecf9;
}
.resultBig{
  display:flex;
  gap:12px;
  align-items:flex-start;
  padding:12px;
  border-radius:18px;
  background: white;
  border:1px solid rgba(0,0,0,.04);
  box-shadow: 0 10px 25px rgba(0,0,0,.06);
}
.emoji{
  font-size:26px;
  line-height:1;
  margin-top:2px;
  white-space: pre-line;
}
.resultText{
  font-size: clamp(18px, 2.4vw, 26px);
  font-weight: 950;
  line-height:1.15;
}
.resultSub{
  margin:10px 0 0;
  color:var(--muted);
  font-size:13px;
  line-height:1.35;
  white-space: pre-line;
}
.modalBtns{
  margin-top:12px;
  display:flex;
  gap:10px;
  flex-wrap:wrap;
}

/* ===== Jar + Post-it styling ===== */
.jarArea{
  margin: 8px 0 6px;
  display:flex;
  gap:14px;
  align-items:center;
  justify-content:space-between;
  flex-wrap:wrap;
}

.jarCard{
  flex: 1 1 320px;
  display:flex;
  align-items:center;
  gap:14px;
  padding:12px;
  border-radius:18px;
  background: linear-gradient(180deg, #fff, #faf7ff);
  border:1px solid var(--stroke);
}

.jarTitle{
  font-weight:950;
  margin:0;
}
.jarHint{
  margin:2px 0 0;
  font-size:13px;
  color:var(--muted);
  line-height:1.35;
}

.jarVisual{
  width:104px;
  height:120px;
  position:relative;
  flex: 0 0 auto;
}

/* lid */
.jarVisual .lid{
  position:absolute;
  top:0;
  left:10px;
  right:10px;
  height:22px;
  border-radius:14px;
  background: linear-gradient(90deg, rgba(185,147,255,.95), rgba(255,143,220,.95));
  box-shadow: 0 10px 18px rgba(0,0,0,.10);
}

/* glass */
.jarVisual .glass{
  position:absolute;
  top:18px;
  left:0;
  right:0;
  bottom:0;
  border-radius:22px;
  background: linear-gradient(180deg, rgba(255,255,255,.55), rgba(255,255,255,.25));
  border: 2px solid rgba(255,255,255,.55);
  box-shadow: inset 0 0 0 2px rgba(185,147,255,.16);
  overflow:hidden;
}

/* papers inside (gentle float) */
.paper{
  position:absolute;
  width:26px; height:18px;
  border-radius:4px;
  background: rgba(255,255,255,.85);
  border:1px solid rgba(0,0,0,.05);
  box-shadow: 0 5px 12px rgba(0,0,0,.08);
  transform: rotate(var(--r, 0deg));
  left: var(--x, 10px);
  top: var(--y, 30px);
  animation: floaty var(--d, 3.4s) ease-in-out infinite;
}
@keyframes floaty{
  0%,100%{ transform: translateY(0px) rotate(var(--r,0deg)); }
  50%{ transform: translateY(-4px) rotate(calc(var(--r,0deg) + 2deg)); }
}
.paper.pink{ background: rgba(255, 209, 238, .92); }
.paper.lav{ background: rgba(217, 199, 255, .92); }
.paper.blue{ background: rgba(207, 232, 255, .92); }
.paper.mint{ background: rgba(200, 255, 232, .92); }

/* subtle shine */
.jarVisual .glass:after{
  content:"";
  position:absolute;
  top:6px; bottom:6px;
  left:10px;
  width:18px;
  border-radius:16px;
  background: rgba(255,255,255,.35);
}

/* Paper fly out animation */
.flyPaper{
  position:absolute;
  left:50%;
  top:62px;
  width:28px;
  height:20px;
  border-radius:5px;
  border:1px solid rgba(0,0,0,.06);
  box-shadow: 0 14px 22px rgba(0,0,0,.15);
  transform: translateX(-50%);
  opacity:0;
  pointer-events:none;
}
.flyPaper.run{
  animation: flyout 520ms ease-out forwards;
}
@keyframes flyout{
  0%{ opacity:0; transform: translateX(-50%) translateY(10px) rotate(-6deg) scale(.9); }
  40%{ opacity:1; transform: translateX(-50%) translateY(-30px) rotate(10deg) scale(1); }
  100%{ opacity:0; transform: translateX(-50%) translateY(-58px) rotate(-8deg) scale(.96); }
}

/* Post-it in modal */
.postitWrap{
  margin-top:10px;
  display:flex;
  justify-content:center;
}
.postit{
  width:min(520px, 100%);
  background: linear-gradient(180deg, var(--postit), var(--postit2));
  border-radius:14px 14px 10px 10px;
  box-shadow: 0 18px 40px rgba(0,0,0,.16);
  border: 1px solid rgba(0,0,0,.08);
  padding:14px 14px 18px;
  position:relative;
  transform: rotate(-1deg);
  animation: popIn 220ms ease-out;
}
@keyframes popIn{
  from{ transform: rotate(-2deg) scale(.97); opacity:.6; }
  to{ transform: rotate(-1deg) scale(1); opacity:1; }
}
.postit:before{
  content:"";
  position:absolute;
  left:0; right:0;
  top:0;
  height:10px;
  border-radius:14px 14px 0 0;
  background: rgba(255,255,255,.35);
}
.postit .label{
  font-weight:950;
  color: rgba(60,40,70,.85);
  font-size:12px;
  letter-spacing:.4px;
}
.postit .book{
  margin-top:8px;
  font-size: clamp(18px, 2.4vw, 26px);
  font-weight: 950;
  line-height:1.15;
}
.postit .note{
  margin-top:10px;
  color: rgba(60,40,70,.75);
  font-size:13px;
  line-height:1.35;
  white-space: pre-line;
}
</style>
</head>

<body>
<div id="confetti"></div>

<div class="container">
  <h1>üíó TBR Game</h1>
  <p class="sub">Tryck <strong>PLAY</strong> n√§r du inte vet vad du ska l√§sa. Rutorna blandas och du f√•r ett tydligt resultat ‚ú®</p>

  <div class="card">

    <div class="jarArea">
      <div class="jarCard">
        <div class="jarVisual" id="jarVisual" aria-hidden="true">
          <div class="lid"></div>
          <div class="glass">
            <div class="paper pink" style="--x:14px;--y:38px;--r:-12deg;--d:3.6s"></div>
            <div class="paper lav"  style="--x:55px;--y:40px;--r:10deg;--d:3.2s"></div>
            <div class="paper blue" style="--x:24px;--y:58px;--r:6deg;--d:3.9s"></div>
            <div class="paper mint" style="--x:60px;--y:63px;--r:-6deg;--d:3.4s"></div>
            <div class="paper pink" style="--x:40px;--y:78px;--r:14deg;--d:3.1s"></div>
            <div class="paper lav"  style="--x:18px;--y:86px;--r:-4deg;--d:3.8s"></div>
          </div>
          <div class="flyPaper" id="flyPaper"></div>
        </div>

        <div>
          <p class="jarTitle">ü´ô TBR Jar</p>
          <p class="jarHint">Klicka <strong>TBR Jar</strong> f√∂r att dra en bok. Nu ‚Äúflyger‚Äù en lapp upp och landar som post-it ‚ú®</p>
        </div>
      </div>
    </div>

    <div class="controls">
      <div class="left">
        <button class="btn primary" id="playBtn">PLAY ‚ú®</button>
        <button class="btn" id="jarBtn">TBR Jar ü´ô</button>
        <button class="btn" id="shuffleBtn">Blanda rutor</button>
        <button class="btn" id="copyBtn">Kopiera senaste</button>
        <button class="btn" id="resetBtn">Reset</button>
      </div>

      <label class="toggle" title="Om p√•: PLAY g√•r igenom allt innan den b√∂rjar om.">
        <input type="checkbox" id="noRepeats" checked />
        No repeats
      </label>
    </div>

    <div class="pills">
      <div class="pill">Drag: <strong id="drawCount">0</strong></div>
      <div class="pill">Kvar (no repeats): <strong id="remaining">-</strong></div>
      <div class="pill">Senaste: <strong id="lastText">-</strong></div>
    </div>

    <div style="height:12px"></div>
    <div class="board" id="board"></div>

    <div class="log" id="log"></div>
  </div>
</div>

<!-- Result modal -->
<div id="modalWrap" role="dialog" aria-modal="true">
  <div class="modal">
    <div class="modalTop">
      <div class="modalTitle">RESULTAT</div>
      <button class="close" id="closeModal">St√§ng</button>
    </div>

    <div class="resultBig">
      <div class="emoji" id="modalEmoji">üíó</div>
      <div>
        <div class="resultText" id="modalText">‚Äî</div>
        <div class="resultSub" id="modalSub">‚Äî</div>

        <div class="postitWrap" id="postitWrap" style="display:none;">
          <div class="postit">
            <div class="label">TBR JAR ‚Ä¢ DIN BOK</div>
            <div class="book" id="postitBook">‚Äî</div>
            <div class="note">Det h√§r √§r din n√§sta bok üòàüíó</div>
          </div>
        </div>

      </div>
    </div>

    <div class="modalBtns">
      <button class="btn primary" id="modalPlayAgain">PLAY igen ‚ú®</button>
      <button class="btn" id="modalJar">TBR Jar ü´ô</button>
      <button class="btn" id="modalCopy">Kopiera</button>
    </div>
  </div>
</div>

<script>
/* UTMANINGAR */
const baseChallenges = [
  "TBR Jar",
  "TBR Jar (blind draw)",
  "TBR Jar (no take backs üòà)",
  "TBR Jar (dramatic reveal üòÇ)",
  "TBR Jar (mystery: titta inte p√• titeln f√∂rr√§n start)",
  "TBR Jar (double draw: dra tv√•, l√§s f√∂rsta)",
  "TBR Jar (lucky draw: dra tre, v√§lj en)",
  "TBR Jar (vibe-first: v√§lj l√§splats, sen dra)",

  "V√§lj en thriller",
  "V√§lj en romantasy",
  "V√§lj en fantasy",
  "V√§lj en romance",
  "V√§lj YA",
  "V√§lj cozy/feelgood",
  "V√§lj dark academia vibes",
  "V√§lj skr√§ck/m√∂rk bok",
  "V√§lj sci-fi",
  "V√§lj historisk fiction",

  "V√§lj enemies to lovers",
  "V√§lj friends to lovers",
  "V√§lj rivals-to-lovers",
  "V√§lj grumpy x sunshine",
  "V√§lj slow burn",
  "V√§lj found family",
  "V√§lj morally grey huvudkarakt√§r",
  "V√§lj ‚Äúcourt politics/royalty‚Äù-vibes",
  "V√§lj ‚Äúacademy/school‚Äù-vibes",
  "V√§lj ‚Äúheist/crew/mission‚Äù-vibes",
  "V√§lj ‚Äúvibes > plot‚Äù",

  "√Ñldsta boken i din TBR",
  "Nyaste bokk√∂pet",
  "Bok du gl√∂mt att du √§ger",
  "Bok med snyggast omslag",
  "Bok med rosa p√• omslaget",
  "Bok med lila p√• omslaget",
  "Bok med blommor p√• omslaget",
  "Bok med ett djur p√• omslaget",
  "Bok med guld/glitter vibes p√• omslaget",
  "Bok med ett ord i titeln",
  "Bok med ett namn i titeln",
  "Slumpa fr√•n hyllan (blunda + peka)",
  "R√§kna 10 b√∂cker in ‚Üí ta den",
  "V√§lj boken du tror blir 5‚≠ê",
  "V√§lj boken du tror blir 3‚≠ê (utmana dig)",
  "V√§lj en du alltid skjuter upp",
  "V√§lj en du √§r lite r√§dd f√∂r att b√∂rja (men g√∂r det üòà)",

  "V√§lj en frist√•ende bok (standalone)",
  "Starta en ny serie (bok 1)",
  "Forts√§tt en serie du p√•b√∂rjat",
  "V√§lj n√§sta bok i en serie du redan √§lskar",
  "V√§lj en duologi-start",
  "V√§lj en trilogi-start",

  "V√§lj en hypead BookTok-bok (som du √§ger)",
  "V√§lj en bok du sett 3+ g√•nger p√• TikTok/IG",
  "V√§lj en bok k√§nd f√∂r plot twist",
  "V√§lj en bok k√§nd f√∂r chemistry",
  "V√§lj en bok k√§nd f√∂r worldbuilding",

  "V√§lj helt fritt (joker)",
  "Dra tv√• alternativ och v√§lj den som k√§nns mest r√§tt",
  "Om du tvekar: v√§lj den du t√§nker p√• f√∂rst",
  "V√§lj den bok som matchar din mood idag",
  "V√§lj den som har kortast titel (lol)",
  "V√§lj den som har snyggast rygg i hyllan",
  "V√§lj den du skulle rekommendera till ‚Äòbok-klubb Therese‚Äô"
];

const extraChallenges = [
  "V√§lj en bok med 1 POV",
  "V√§lj en bok med flera POV",
  "V√§lj en bok med ‚Äúmystery element‚Äù",
  "V√§lj en bok med ‚Äúquest/adventure‚Äù",
  "V√§lj en bok med stark female main character",
  "V√§lj en bok som k√§nns som ‚Äúautumn vibes‚Äù",
  "V√§lj en bok som k√§nns som ‚Äúwinter vibes‚Äù",
  "V√§lj en bok som k√§nns som ‚Äúspring vibes‚Äù",
  "V√§lj en bok som k√§nns som ‚Äúsummer vibes‚Äù",
  "V√§lj en bok som √§r mer action √§n romance",
  "V√§lj en bok som √§r mer romance √§n action",
  "V√§lj en bok du k√∂pt pga omslag",
  "V√§lj en bok som ligger n√§rmast dig just nu",
  "V√§lj en bok som √§r l√§ngst bort i hyllan (lol)",
  "V√§lj en bok du vill kunna prata om efter√•t",
  "V√§lj en bok du vill ‚Äòsluka‚Äô",
  "V√§lj en bok du vill ‚Äòmysl√§sa‚Äô",
  "V√§lj en bok du vill bli √∂verraskad av",
  "V√§lj en bok du tror blir en ny favorit",
  "V√§lj en bok som k√§nns lite ‚Äòrandom‚Äô"
];

const challenges = [...baseChallenges, ...extraChallenges];

/* TBR JAR b√∂cker (l√§gg till fler som du vill) */
const tbrJarBooks = [
  "A Court of Thorns and Roses ‚Äì Sarah J. Maas",
  "Divine Rivals ‚Äì Rebecca Ross",
  "Powerless ‚Äì Lauren Roberts",
  "One Dark Window ‚Äì Rachel Gillig",
  "Belladonna ‚Äì Adalyn Grace",
  "The Serpent and the Wings of Night ‚Äì Carissa Broadbent",
  "Once Upon a Broken Heart ‚Äì Stephanie Garber",
  "A Good Girl‚Äôs Guide to Murder ‚Äì Holly Jackson",
  "Beach Read ‚Äì Emily Henry",
  "The Housemaid ‚Äì Freida McFadden",
  "Crescent City ‚Äì Sarah J. Maas",
  "Shatter Me ‚Äì Tahereh Mafi",
  "Ett litet liv ‚Äì Hanya Yanagihara"
];

/* UI / Logic */
const boardEl = document.getElementById("board");
const logEl = document.getElementById("log");
const drawCountEl = document.getElementById("drawCount");
const remainingEl = document.getElementById("remaining");
const lastTextEl = document.getElementById("lastText");
const noRepeatsEl = document.getElementById("noRepeats");

const modalWrap = document.getElementById("modalWrap");
const modalEmoji = document.getElementById("modalEmoji");
const modalText = document.getElementById("modalText");
const modalSub = document.getElementById("modalSub");

const postitWrap = document.getElementById("postitWrap");
const postitBook = document.getElementById("postitBook");

const confettiLayer = document.getElementById("confetti");
const flyPaper = document.getElementById("flyPaper");

let drawCount = 0;
let lastPickedText = "";
let activeIndex = null;

let boardOrder = [];
let pool = [];

function shuffle(arr){
  for(let i = arr.length - 1; i > 0; i--){
    const j = Math.floor(Math.random() * (i+1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
}

function emojiFor(text){
  const t = text.toLowerCase();
  if (t.includes("tbr jar")) return "ü´ô";
  if (t.includes("thriller")) return "üî™";
  if (t.includes("romantasy")) return "üêâ";
  if (t.includes("fantasy")) return "‚ú®";
  if (t.includes("romance")) return "üíû";
  if (t.includes("ya")) return "üéí";
  if (t.includes("cozy")) return "‚òï";
  if (t.includes("dark academia")) return "üñãÔ∏è";
  if (t.includes("skr√§ck") || t.includes("m√∂rk")) return "üïØÔ∏è";
  if (t.includes("sci-fi")) return "ü™ê";
  if (t.includes("historisk")) return "üèõÔ∏è";
  if (t.includes("joker")) return "üÉè";
  if (t.includes("omslag")) return "üéÄ";
  if (t.includes("serie")) return "üìö";
  if (t.includes("tiktok") || t.includes("booktok")) return "üì±";
  return "üíó";
}

function log(line){
  const now = new Date().toLocaleString("sv-SE");
  logEl.textContent = `[${now}] ${line}\n` + logEl.textContent;
}

function popConfetti(){
  const colors = ["#ff8fdc","#b993ff","#ffd1ee","#d9c7ff","#cfe8ff","#c8ffe8","#ffe1a6"];
  for(let i=0;i<24;i++){
    const d=document.createElement("div");
    d.className="confetti";
    d.style.left=(10 + Math.random()*80) + "vw";
    d.style.top=(-20 - Math.random()*60) + "px";
    d.style.background=colors[Math.floor(Math.random()*colors.length)];
    d.style.animationDuration=(700+Math.random()*500)+"ms";
    d.style.width=(8+Math.random()*8)+"px";
    d.style.height=(10+Math.random()*12)+"px";
    confettiLayer.appendChild(d);
    setTimeout(()=>d.remove(), 1300);
  }
}

function showModal(text, subText){
  postitWrap.style.display = "none";
  modalEmoji.textContent = emojiFor(text);
  modalText.textContent = text;
  modalSub.textContent = subText || "";
  modalWrap.style.display = "flex";
}

function showJarPostit(book){
  modalEmoji.textContent = "ü´ô";
  modalText.textContent = "TBR Jar";
  modalSub.textContent = "Du drog en bok! üíó";

  postitBook.textContent = book;
  postitWrap.style.display = "flex";
  modalWrap.style.display = "flex";
}

function closeModal(){
  modalWrap.style.display = "none";
}

function resetBoardOrder(){
  boardOrder = challenges.map((_,i)=>i);
  shuffle(boardOrder);
  resetPool();
  renderBoard();
}

function resetPool(){
  pool = boardOrder.map((_,pos)=>pos);
  shuffle(pool);
  updateRemaining();
}

function updateRemaining(){
  remainingEl.textContent = noRepeatsEl.checked ? String(pool.length) : "‚àû";
}

function renderBoard(){
  boardEl.innerHTML = "";
  boardOrder.forEach((challengeIndex, pos)=>{
    const text = challenges[challengeIndex];
    const cell = document.createElement("div");
    cell.className = "cell" + (pos === activeIndex ? " active" : "");
    cell.textContent = text;
    cell.addEventListener("click", ()=> pickByBoardPos(pos, "KLICK"));
    boardEl.appendChild(cell);
  });
}

function pickRandomBoardPos(){
  if (!noRepeatsEl.checked){
    return Math.floor(Math.random()*boardOrder.length);
  }
  if (pool.length === 0) resetPool();
  return pool.pop();
}

function pickByBoardPos(pos, source){
  activeIndex = pos;
  const text = challenges[ boardOrder[pos] ];
  lastPickedText = text;

  drawCount++;
  drawCountEl.textContent = String(drawCount);
  lastTextEl.textContent = text;

  renderBoard();
  updateRemaining();
  log(`${source} ‚Üí "${text}"`);

  const sub = text.toLowerCase().includes("tbr jar")
    ? "Du landade p√• TBR Jar! Klicka TBR Jar-knappen f√∂r att dra en bok ü´ô"
    : "Det h√§r √§r din riktning. V√§lj en bok som matchar rutan üíó";
  showModal(text, sub);
}

/* Fly-out animation helper */
function playJarAnimation(){
  const colors = ["rgba(255,209,238,.92)","rgba(217,199,255,.92)","rgba(207,232,255,.92)","rgba(200,255,232,.92)"];
  flyPaper.style.background = colors[Math.floor(Math.random()*colors.length)];
  flyPaper.classList.remove("run");
  void flyPaper.offsetWidth; // restart animation
  flyPaper.classList.add("run");
}

/* TBR Jar ‚Äì fly paper + post-it */
function jarPick(){
  if(!tbrJarBooks.length) return alert("L√§gg in b√∂cker i tbrJarBooks üôÇ");
  const book = tbrJarBooks[Math.floor(Math.random()*tbrJarBooks.length)];

  playJarAnimation();
  popConfetti();

  // liten delay s√• det k√§nns som att lappen "flyger upp" innan post-it visas
  setTimeout(()=> showJarPostit(book), 260);

  log(`TBR JAR ‚Üí ${book}`);
}

/* Copy */
async function copyLatest(){
  if (!lastPickedText) return alert("Tryck PLAY f√∂rst üôÇ");
  try{
    await navigator.clipboard.writeText(lastPickedText);
    log(`Kopierade: "${lastPickedText}"`);
    alert("Kopierat! ‚úÖ");
  }catch{
    alert("Kunde inte kopiera automatiskt. Markera och kopiera manuellt üôÇ");
  }
}

/* Buttons */
document.getElementById("playBtn").addEventListener("click", ()=>{
  popConfetti();
  const pos = pickRandomBoardPos();
  pickByBoardPos(pos, "PLAY");
});

document.getElementById("jarBtn").addEventListener("click", jarPick);

document.getElementById("shuffleBtn").addEventListener("click", ()=>{
  resetBoardOrder();
  log("Blandade rutorna.");
});

document.getElementById("copyBtn").addEventListener("click", copyLatest);

document.getElementById("resetBtn").addEventListener("click", ()=>{
  drawCount = 0;
  drawCountEl.textContent = "0";
  lastPickedText = "";
  lastTextEl.textContent = "-";
  activeIndex = null;
  logEl.textContent = "";
  resetBoardOrder();
  log("Reset.");
});

noRepeatsEl.addEventListener("change", ()=>{
  resetPool();
  log(`No repeats: ${noRepeatsEl.checked ? "P√Ö" : "AV"}`);
});

document.getElementById("closeModal").addEventListener("click", closeModal);
document.getElementById("modalPlayAgain").addEventListener("click", ()=>{
  closeModal();
  document.getElementById("playBtn").click();
});
document.getElementById("modalJar").addEventListener("click", ()=>{
  closeModal();
  jarPick();
});
document.getElementById("modalCopy").addEventListener("click", copyLatest);

modalWrap.addEventListener("click", (e)=>{
  if (e.target === modalWrap) closeModal();
});

/* Init */
resetBoardOrder();
updateRemaining();
log("Spelet startat.");
</script>
</body>
</html>
